# kdtree_storage.py
# ğŸ§  MÃ³dulo de almacenamiento y bÃºsqueda simbÃ³lica en espacio fractal
# Autor: Dicaoz â€“ Eduardo Molina ğŸ‡ªğŸ‡¨

from sklearn.neighbors import KDTree
import numpy as np

class FractalKDStorage:
    def __init__(self):
        self.storage = []
        self.kdtree = None

    def agregar_glifo(self, glifo, metadata):
        """
        Agrega un glifo fractal con su metadata simbÃ³lica.
        """
        compressed_data = (
            metadata['parametros'],
            metadata['semilla'],
            np.mean(glifo, axis=0)
        )
        self.storage.append(compressed_data)

    def construir_indice(self):
        """
        Construye el Ã­ndice KDTree para bÃºsquedas rÃ¡pidas por proximidad.
        """
        data_points = [x[2] for x in self.storage]
        self.kdtree = KDTree(np.array(data_points))

    def buscar_similar(self, glifo_muestra, k=5):
        """
        Busca los k glifos mÃ¡s similares a una muestra.
        """
        query_point = np.mean(glifo_muestra, axis=0).reshape(1, -1)
        dist, idx = self.kdtree.query(query_point, k=k)
        return [self.storage[i] for i in idx[0]]
